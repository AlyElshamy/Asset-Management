@page
@model AssetProject.Areas.Admin.Pages.AssetManagment.AssetListModel
@{
}

<div class="slim-mainpanel">
    <div class="container">
        <div class="slim-pageheader">
            <ol class="breadcrumb slim-breadcrumb">
                <li class="breadcrumb-item"><a href="#">Home</a></li>
                <li class="breadcrumb-item"><a href="#">Assets</a></li>
                <li class="breadcrumb-item active" aria-current="page">Assets List</li>
            </ol>
            <h6 class="slim-pagetitle">Assets List</h6>
        </div><!-- slim-pageheader -->
        <div class="section-wrapper">
            <label class="section-title d-inline">Assets List</label>
            <a asp-area="Admin" asp-page="/AssetManagment/AddAsset" class="btn btn-primary" style="float:right"> Add New Contract   </a>
            <p class="mg-b-20 mg-sm-b-40">Searching, ordering and paging goodness will be immediately added to the table, as shown in this example.</p>
            <div class="table-wrapper">
                <div id="datatable1_wrapper" class="dataTables_wrapper no-footer">
                    @(Html.DevExtreme().DataGrid<AssetProject.Models.Asset>()
                    .DataSource(ds => ds.Mvc()
                    .Controller("Assets")
                    .LoadAction("Get")
                    .UpdateAction(true)
                    .InsertAction(true)
                    .DeleteAction(true)
                    .Key("AssetId")
                    )
                    .HeaderFilter(headerFilter => headerFilter.Visible(true))
                    .Selection(s => s
                    .Mode(SelectionMode.Multiple)
                    )
                    .ColumnChooser(cc => cc.Enabled(true))
                    .ColumnAutoWidth(true)
                    .WordWrapEnabled(true)
                     .ShowBorders(true)
    .Paging(p=>p.PageSize(10))
    .Pager(p=>p.ShowPageSizeSelector(true).AllowedPageSizes(new [] {10,20,40,80}))
    .SearchPanel(s=>s.Visible(true).HighlightCaseSensitive(true))
    .FilterRow(filterRow => filterRow
        .Visible(true)
        .ApplyFilter(GridApplyFilterMode.Auto)
    )
      .HeaderFilter(headerFilter => headerFilter.Visible(true))
                    .Columns(columns => {

                    columns.Add().Caption("Action").Alignment(HorizontalAlignment.Center).CellTemplate(@<text>
                            <a href="/Admin/AssetManagment/AssetDetails?id=<%- data.AssetId %>"> View </a>
                        </text>).Width(150);
                    })
                    .Columns(columns => {


                    columns.AddFor(m => m.Photo).Width(100)
                    .AllowFiltering(false)
                    .AllowSorting(false)
                    .CellTemplate(@<text>
                            <div>
                                <img src="<%- value %>" alt="" width="35" height="35" />
                            </div>
                        </text>);
                    columns.AddFor(m => m.AssetDescription);

                    columns.AddFor(m => m.AssetTagId);

                    columns.AddFor(m => m.AssetCost);

                    columns.AddFor(m => m.AssetSerialNo);

                    columns.AddFor(m => m.AssetPurchaseDate);

                    columns.AddFor(m => m.ItemId).Caption("Item").Lookup(lookup => lookup
                    .DataSource(ds => ds.WebApi().Controller("Assets").LoadAction("ItemsLookup").Key("Value"))
                    .ValueExpr("Value")
                    .DisplayExpr("Text")
                    );



                    //columns.AddFor(m => m.DepreciableAsset);

                    //columns.AddFor(m => m.DepreciableCost);

                    //columns.AddFor(m => m.SalvageValue);

                    //columns.AddFor(m => m.AssetLife);

                    //columns.AddFor(m => m.DateAcquired);

                    //columns.AddFor(m => m.DepreciationMethodId).Lookup(lookup => lookup
                    //    .DataSource(ds => ds.WebApi().Controller("Assets").LoadAction("DepreciationMethodsLookup").Key("Value"))
                    //    .ValueExpr("Value")
                    //    .DisplayExpr("Text")
                    //);

                    })
                    .RemoteOperations(true).Columns(columns =>
                    {
                    columns.Add().Width(160).Alignment(HorizontalAlignment.Center)
                    .CellTemplate(@<text>
                            @Html.DevExtreme().Button().Text("Edit").OnClick("function (e) { editButtonClick(data) }")
                            @Html.DevExtreme().Button().Text("Delete").OnClick("function (e) { deleteButtonClick(data) }")
                            @Html.DevExtreme().Button().Text("View").OnClick("function (e) { viewButtonClick(data) }")
                        </text>);

                    })

                    )


                    @(Html.DevExtreme().Popup().ID("customPopup").Title("Custom popup edit").Visible(false)
                    .ContentTemplate(@<text>
                            @Html.Label("CustomText")
                            @Html.DevExtreme().TextBox().ID("TxtAssetTagId")
                            @Html.DevExtreme().Button().Text("Save").OnClick("function (e) { saveButtonClick() }")
                            @Html.DevExtreme().Button().Text("Cancel").OnClick("function (e) { cancelButtonClick() }")
                        </text>))


                </div>
            </div><!-- table-wrapper -->
        </div><!-- section-wrapper -->

    </div><!-- container -->
</div>

<script>
        var currentKey;
    function editButtonClick(data) {
        $('#customPopup').dxPopup('instance').option('visible', true);
        var textBox = $('#TxtAssetTagId').dxTextBox('instance');
        textBox.option('value', data.AssetTagId);
        currentKey = data.AssetId;
    }
    function deleteButtonClick(data) {
        var grid = $('#gridContainer').dxDataGrid('instance');
        var rowIndex = grid.getRowIndexByKey(data.OrderID);
        grid.deleteRow(rowIndex);
    }
    function saveButtonClick() {
        var grid = $('#gridContainer').dxDataGrid('instance');
        var textBox = $('#TxtAssetTagId').dxTextBox('instance');
        var value = textBox.option('value');
        console.log(value)
        console.log(currentKey)
        //var rowIndex = grid.getRowIndexByKey(currentKey);
        //grid.cellValue(rowIndex, "AssetTagId", value);
        //var values = $("#editForm").dxForm("instance").option('formData');
        grid.getDataSource().store().update(value).done(function(){ grid.refresh() })
            //$.ajax({
            //    type: "PUT",
            //    traditional: true,
            //    contentType: 'application/json; charset=utf-8',
            //    url: "@Url.Action("Put", "Assets")",
            //    data: JSON.stringify(value),
            //    success: function (data) {
            //        if (data == "OK") {
            //            $("#GridView").dxDataGrid("instance").refresh();
            //            $("#editFormPopup").dxPopup("instance").hide();
            //        }
            //        else
            //            alert(data);
            //    }
            //});
        //grid.saveEditData()
        //grid.refersh()
        $('#customPopup').dxPopup('instance').option('visible', false);
        currentKey = -1;
    }
    function cancelButtonClick() {
        $('#customPopup').dxPopup('instance').option('visible', false);
        currentKey = -1;
    }
    function viewButtonClick(data) {
        alert (data);
        var pop=    $('#customPopup').dxPopup('instance');
    @*pop.show();*@
        pop.option('visible', true);
        var textBox = $('#TxtAssetTagId').dxTextBox('instance');
        textBox.option('value', data.AssetTagId);
        currentKey = data.AssetId;
    }


</script>

        @section Scripts {
            <partial name="_ValidationScriptsPartial" />
             <script type="text/javascript">

                // Add the following code if you want the name of the file appear on select
                $("#text").on("change", function () {
                var fileName = $(this).val().split("\\").pop();
                    $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
            });

            </script>
        }
